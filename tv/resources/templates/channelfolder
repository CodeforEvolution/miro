<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      eventCookie="@@@eventCookie@@@" dtvPlatform="@@@dtvPlatform@@@">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <link href="resource:css/main.css" rel="stylesheet" type="text/css" />
    <t:include filename="dynamic.js" />
    <script type="text/javascript" src="resource:templates/shide.js" />
    <script type="text/javascript" src="resource:templates/channel.js" />
    <t:execOnLoad><![CDATA[
folder = views.channelFolders.getObjectByID(int(kargs['id']))
allFeeds = views.feeds.filterWithIndex(indexes.byFolder, folder)

global searchTerm
searchTerm = None

allItems = views.items.filterWithIndex(indexes.itemsByChannelFolder, folder)
matchingItems = allItems.filter(lambda x: filters.matchingItems(x, searchTerm))
downloadingItems = matchingItems.filter(filters.downloadingItems)
thisFolderView = views.channelFolders.filter(lambda x: x is folder)

matchingItems.createIndex(indexes.itemsByChannelCategory)
def makeStateView(cat):
    view = matchingItems.filterWithIndex(indexes.itemsByChannelCategory, cat)
    return view.sort(sorts.item)
newItems = makeStateView('new')
oldItems = matchingItems.filter(filters.viewedItems).sort(sorts.item)
unwatchedItems = makeStateView('newly-downloaded')
expiringItems = makeStateView('expiring')
savedItems = makeStateView('saved')

if newItems.len() == unwatchedItems.len() == expiringItems.len() == savedItems.len() == 0:
    mainChannelbarAvailableDisplay = newlyAvailableSeenDisplay = "block"
    showMoreVideosDisplay = "none"
else:
    mainChannelbarAvailableDisplay = newlyAvailableSeenDisplay = "none"
    showMoreVideosDisplay = "block"

def updateSearchString(newSearch):
    global searchTerm
    if len(newSearch) == 0:
        searchTerm = None
    else:
        searchTerm = newSearch
    allItems.recomputeFilter(matchingItems)

for feed in allFeeds:
    feed.updateIcons()
]]>
    </t:execOnLoad>
    <t:execOnUnload><![CDATA[
# This should unlink matchingItems and all of it's children
allItems.unlink()
thisFolderView.unlink()
for feed in allFeeds:
    feed.markAsViewed()
]]>
    </t:execOnUnload>
</head>

<body>

<!-- TITLE BAR ************************************************************ -->
<div id="main-titlebar">
        <img id="main-titlebar-avatar" src="resource:images/playlist-icon.png" alt="" />
	<div id="main-titlebar-channelname">
	    <div t:updateForView="thisFolderView">
                <h1 t:replaceMarkup="folder.getTitle()" />
	    </div>
        </div>
        <div id="main-titlebar-tasks">
                <div id="main-titlebar-tasks-search">
                    <input type="search" placeholder="Search Folder" class="main-titlebar-tasks-search" onfocus="startEditSearch(this, showAllVideos)" onblur="endEditSearch()" />
                </div>
        </div>
</div>
<!-- / TITLE BAR -->
<!-- CHANNEL CONTAINER **************************************************** -->
<div id="main-container">
    <t:includeTemplate filename="channel-content" />
</div>
<!-- / CHANNEL ITEMS LIST -->

</body>
</html>
